# ValorApp ‚Äì Gu√≠a para agentes (Copilot)

## Visi√≥n general
Aplicaci√≥n corporativa para el an√°lisis de consumo energ√©tico basada en registros ATR (CSV/Excel). Detecta anomal√≠as (fraude/aver√≠a) y permite gestionar registros locales. No hay autenticaci√≥n ni backend: acceso libre, datos en localStorage.

## Arquitectura y patrones clave
- Arquitectura modular (presentaci√≥n, negocio, estado) con React + TypeScript
- Contexto √∫nico: `StoreProvider` (en `src/main.tsx`)
- Persistencia: localStorage (clave principal `valorApp.registros`), m√°s claves auxiliares
- SPA por hash: `useHashRoute()` en `src/App.tsx`
- Rutas: `#/`, `#/wart`, `#/analisis-expediente`, `#/export-saldo-atr`, `#/ver-saldo-atr`

## P√°ginas y responsabilidades
- Dashboard (`src/pages/Dashboard/`): listado y m√©tricas de registros del store; filtros r√°pidos
- WART (`src/pages/Wart/Wart.tsx`): checklist, ‚Äúcambio de titular‚Äù y ‚Äúfecha del acta‚Äù (persisten en localStorage)
- An√°lisis de Expediente (`src/pages/AnalisisExpediente/`): parsing de Excel, KPIs y tabla
- Export Saldo ATR (`src/pages/ExportSaldoATR/ExportSaldoATR.tsx`): import CSV/Excel ATR y guardado
- Vista ATR (`src/pages/ExportSaldoATR/ATRPreview.tsx`): previsualizaci√≥n, filtrado, series y detecci√≥n de anomal√≠as
- Formularios ATR (`src/pages/ATRForm/`): creaci√≥n/edici√≥n de registros con validaci√≥n

## Estado y servicios
- `src/state/StoreContext.tsx`: reducer + acciones (INIT/ADD/REMOVE/CLEAR/SET_LOADING/SET_ERROR)
- `src/services/atr/atrService.ts`: CRUD, validaci√≥n, b√∫squeda y totales kWh, persistencia
- `src/services/storage/storageService.ts`: servicio gen√©rico de storage (local/session)

## Persistencia (claves)
- `valorApp.registros` (registros ATR manuales)
- `valorApp.analisis.atrCsv` (dataset importado: { headers, rows })
- `valorApp.analisisExpediente` (items parseados de expediente)
- `valorApp.analisis.tipoContador` ('Tipo V' | 'Tipo IV')
- `valorApp.wart.cambioTitular` ({ tuvoCambioTitular, fecha })
- `valorApp.wart.fechaActa` (string ISO)

## Calidad de c√≥digo y herramientas
- ESLint (React/TS) + Prettier + EditorConfig
- Vitest + React Testing Library (mock de storages en `src/test/setup.ts`)
- Vite + `@vitejs/plugin-react`

### Scripts (package.json)
```json
{
  "dev": "vite --host",
  "build": "vite build",
  "preview": "vite preview",
  "start": "vite preview --host",
  "typecheck": "tsc --noEmit",
  "lint": "eslint src --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
  "lint:fix": "eslint src --ext ts,tsx --fix",
  "format": "prettier --write src",
  "test": "vitest",
  "test:coverage": "vitest --coverage"
}
```

### Workflow recomendado
1) `npm run dev` ‚Üí desarrollo
2) `npm run lint` / `npm run typecheck` ‚Üí calidad
3) `npm run test` ‚Üí pruebas
4) `npm run build` y `npm run preview` ‚Üí verificaci√≥n final

## Convenciones del proyecto
- UI y comentarios en espa√±ol; emojis opcionales (üìä, ‚ö†Ô∏è, ‚úÖ) para jerarqu√≠a
- Imports sin extensi√≥n TS y ordenados
- N√∫meros en inputs: `parseFloat(e.target.value) || 0`
- Componentes: responsabilidad √∫nica y <150 l√≠neas; extraer l√≥gica a hooks
- Mantener rutas por hash y estilos corporativos (ver `docs/DESIGN_SYSTEM.md`)

## Patrones de implementaci√≥n
- Hooks especializados para negocio (`useATRData`, `useWARTModule`, `useActaFacturaValidation`)
- Formularios con validaci√≥n previa; mensajes claros de error
- Optimizaci√≥n con `useMemo`/`useCallback` y React.memo en componentes puros

## Detecci√≥n de anomal√≠as (gu√≠a r√°pida)
- Implementaci√≥n principal en `src/pages/ExportSaldoATR/ATRPreview.tsx`
- Criterio 0: consumo nulo sostenido (‚â§1 kWh por ‚â•2 meses)
- Umbral operativo: ¬±40% (variaci√≥n cr√≠tica)
- Validaciones cruzadas: Z-Score, estacionalidad, ca√≠da/incremento significativo
- Detalle completo: `docs/DETECCION_ANOMALIAS_CONSUMO.md`

## Manejo de errores y accesibilidad
- try/catch en operaciones as√≠ncronas; errores globales en `StoreContext`
- Accesibilidad: labels/roles ARIA, foco visible, contraste suficiente, navegaci√≥n por teclado

## Archivos clave
```
src/
‚îú‚îÄ‚îÄ App.tsx                  # Router por hash
‚îú‚îÄ‚îÄ main.tsx                 # Providers
‚îú‚îÄ‚îÄ state/StoreContext.tsx   # Estado global
‚îú‚îÄ‚îÄ services/atr/atrService.ts
‚îú‚îÄ‚îÄ services/storage/storageService.ts
‚îú‚îÄ‚îÄ types/atr.ts             # Tipos de dominio
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ Dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ Wart/
‚îÇ   ‚îú‚îÄ‚îÄ AnalisisExpediente/
‚îÇ   ‚îî‚îÄ‚îÄ ExportSaldoATR/
‚îî‚îÄ‚îÄ utils/csv.ts             # Parser CSV robusto
```

## Pr√≥ximas integraciones y mejoras
- Refactor de `ATRPreview` en subm√≥dulos + tests unitarios
- Web Worker para parsing y agregados
- Tabla virtualizada y export de reportes
- Acciones de borrado seguro de datos locales
- PWA / i18n / dark mode (opcional)

## Nota para agentes (Copilot)
- Favorecer cambios peque√±os y testeables; no introducir autenticaci√≥n
- No romper el enrutado por hash ni las claves de localStorage existentes
- Si a√±ades claves nuevas, documentarlas en esta gu√≠a
- Mantener textos en espa√±ol y coherencia visual con `DESIGN_SYSTEM.md`

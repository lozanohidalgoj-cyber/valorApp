# 🔍 Análisis del Caso: Anomalía NO Detectada - ES0031101927321001MV0F

## 📊 Datos del Cliente

```
CUPS: ES0031101927321001MV0F
Contrato ATR: 97132404888 → 5,00007E+11 (cambio de contador)
Período: 26/12/2018 - 04/07/2025
Anomalía esperada: **2022** (Consumo 0 kWh durante 6 meses)
```

---

## 📈 Evolución del Consumo Mensual

```
2019:
   ENE    FEB    MAR    ABR    MAY    JUN    JUL    AGO    SEP    OCT    NOV    DIC
  244   317   354     0    429   994   572  1662   1418  1934     0   ???
  ↓     ↓     ↓    [ANULADA] ↑     ↑     ↑     ↑      ↑     ↑    [ANULADA]

2020:
   JAN    FEB    MAR    APR    MAY    JUN    JUL    AUG    SEP    OCT    NOV    DEC
  597    362    696    674    718  1308  2125  1592  1155  1314   980    938
  
2021:
   JAN    FEB    MAR    APR    MAY    JUN    JUL    AUG    SEP    OCT    NOV    DEC
  689    745    440    756    593    149    876    998 29.347  1308   638  1778
                                                          ↑↑↑ ANOMALÍA COMPLEMENTARIA

2022:
   JAN    FEB    MAR    APR    MAY    JUN    JUL    AUG    SEP    OCT    NOV    DEC
 1753     0      0      0      0      0      0      0      0      8    1772  2342
  ↓     ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ ← AQUÍ: ANOMALÍA DE DESCENSO PROLONGADO
                                                                      ↑ RECUPERACIÓN

2023:
   JUN    JUL    AUG    SEP    OCT    NOV    DEC
          123    216     85     57     83    220    478    192
                                      ↑ Cambio de contador (Baja + Alta)
                                      Potencia: 13,856 → 1,3 → 13 → 3

2024:
   JAN    FEB    MAR    APR    MAY    JUN    JUL    AUG    SEP    OCT    NOV    DEC
  183    128    128    151     66    136    124    147    128    162    107    180

2025:
   JAN    FEB    MAR    APR    MAY    JUN
  101    155    117    151    108    159
```

---

## 🚨 ANOMALÍA IDENTIFICADA: FEBRERO - SEPTIEMBRE 2022

### Características de la Anomalía

```
Período de anomalía: 2022-02 a 2022-09 (8 MESES)
Duración: 8 meses consecutivos
Consumo en período: 0 kWh
Estado: "Real" (Medida real, no estimada)
Tipo de factura: "Factura de ciclo" (Normal)

Consumo anterior (2022-01): 1,752.54 kWh
Consumo en anomalía: 0 kWh cada mes
Variación: -100% (Caída total)
Recuperación (2022-10): 7.592 kWh (débil)
Recuperación total (2022-11): 1,771.68 kWh
```

### Por qué el Sistema NO la Detecta

#### Problema 1: Exclusión de 0 o Valores Muy Pequeños
```typescript
// El código actual probablemente omite o no maneja bien:
if (consumo === 0 || consumo < 0.1) {
  // → NO SE PROCESA O SE SALTA
}

// Realidad del cliente:
const consumoFebrero2022 = 0  // ← Valor real en los datos
const consumoMarzo2022 = 0
const consumoAbril2022 = 0
// ... etc hasta septiembre = 0
```

**Impacto:** Los meses con consumo 0 no generan Z-Score significativo porque:
```
Z-Score = (0 - baseline) / σ
        = (0 - 1000) / 500  [ejemplo]
        = -2.0

Aunque es -2.0 (outlier en teoría), el sistema podría estar:
✗ Filtrando valores 0
✗ No calcular variación porcentual (división por 0)
✗ Ignorar persistencia en ceros
```

#### Problema 2: Falta de Recuperación Débil
```typescript
// Criterio 3: Tendencia Sostenida Confirmada
umbralRecuperacion = Math.max(prev * 0.85, baselineAvg * 0.8)
                   = Math.max(0 * 0.85, 1000 * 0.8)
                   = 800 kWh

// En octubre 2022:
consumo_octubre = 7.592 kWh
¿Ha recuperado? 7.592 > 800? → NO
✗ Se detectaría recuperación solo en noviembre (+1,771.68)

// El algoritmo rompe el análisis porque espera recuperación rápida
// pero aquí fue gradual: 0 → 7.6 → 1,771.6
```

#### Problema 3: Cambio de Contador (Potencia)
```
Antes de la anomalía:
  Potencia: 13,856 kW (cliente importante, industrial)
  
Durante la anomalía:
  Potencia: 13,856 kW (igual, pero consumo = 0)
  
Después (2023):
  Potencia: 1.3 kW → 13 kW → 3 kW (CAMBIOS MÚLTIPLES)
  
→ El sistema pierde continuidad por cambios de contador/potencia
```

#### Problema 4: Período de Inicio de Análisis
```typescript
// En el código:
const startAnalysisFrom = Math.max(1, 3)  // Empieza desde mes 4

// Pero en tus datos:
// Período completo: 50+ meses
// Meses 1-3: Datos iniciales (2019)
// Meses 20-28: ANOMALÍA ESTÁ AQUÍ (2022)

→ El análisis puede estar empezando bien, pero sin contexto
  de que hace 1 año había 1,700+ kWh vs ahora 0 kWh
```

---

## 🔧 SOLUCIONES RECOMENDADAS

### Solución 1: Tratar Valores 0 como Anomalía Crítica

```typescript
// NUEVO CRITERIO: Consumo Nulo Prolongado
const hasNullConsumption = () => {
  let consecutiveZeros = 0
  
  for (let i = startAnalysisFrom; i < withVar.length; i++) {
    if (withVar[i].consumo <= 1) {  // ← Casi nulo
      consecutiveZeros++
    } else {
      if (consecutiveZeros >= 2) {  // ← 2+ meses seguidos
        return {
          detected: true,
          monthsOfZero: consecutiveZeros,
          startIdx: i - consecutiveZeros,
          startMonth: withVar[i - consecutiveZeros].month,
          startYear: withVar[i - consecutiveZeros].year
        }
      }
      consecutiveZeros = 0
    }
  }
  
  if (consecutiveZeros >= 2) {
    return {
      detected: true,
      monthsOfZero: consecutiveZeros,
      startIdx: withVar.length - consecutiveZeros,
      startMonth: withVar[withVar.length - consecutiveZeros].month,
      startYear: withVar[withVar.length - consecutiveZeros].year
    }
  }
  return { detected: false }
}
```

### Solución 2: Calcular Variación sin Dividir por 0

```typescript
// CORRECCIÓN: Manejar división por 0
const calcularVariacion = (actual: number, anterior: number) => {
  if (anterior === 0) {
    // Si anterior es 0 y actual es 0 → Sin cambio (-100% no aplica)
    if (actual === 0) return 0
    // Si anterior es 0 y actual > 0 → Recuperación
    if (actual > 0) return 999  // Marcar como "recuperación infinita"
  }
  if (actual === 0 && anterior > 0) {
    return -100  // Caída total a 0
  }
  return ((actual - anterior) / anterior)
}

// Aplicación:
const variacion_feb = calcularVariacion(0, 1752.54)  // = -100%
const variacion_mar = calcularVariacion(0, 0)        // = 0%
const variacion_oct = calcularVariacion(7.592, 0)    // = 999 (recuperación)
```

### Solución 3: Extender Análisis de Persistencia

```typescript
// MEJORADO: Persistencia con recuperación lenta
const analizarPersistenciaConRecuperacion = (startIdx: number) => {
  let monthsBelow = 0
  let hasPartialRecovery = false
  
  for (let j = 1; j <= 3; j++) {
    if (startIdx + j >= withVar.length) break
    
    const siguienteMes = withVar[startIdx + j]
    
    // Nulo = persiste
    if (siguienteMes.consumo < 1) {
      monthsBelow++
      continue
    }
    
    // Recuperación parcial (< 50% del baseline) = sigue siendo anómalo
    if (siguienteMes.consumo < baselineAvg * 0.5) {
      monthsBelow++
      hasPartialRecovery = true
      continue
    }
    
    // Recuperación completa
    if (siguienteMes.consumo >= baselineAvg * 0.8) {
      break
    }
  }
  
  return {
    persistent: monthsBelow >= 2,
    months: monthsBelow,
    hasPartialRecovery
  }
}
```

### Solución 4: Nuevo Criterio de Anomalía

```typescript
// CRITERIO 4: Consumo Nulo Sostenido (NUEVO)
if (consecutiveZeros >= 2) {
  // Anomalía por consumo nulo sostenido
  firstDrop = startIdxOfZeros
  detectedAnomalyYM = { year: yearOfAnomaly, month: monthOfAnomaly }
  anomalyMetadata = {
    criterio: 'Consumo nulo sostenido - Posible avería/fraude',
    confianza: 0.95,  // Muy alta confianza
    baseline: baselineAvg,
    actual: 0,
    caida: 1.0,  // 100% de caída
    persistencia: consecutiveZeros,
    desvEstandar: 999  // Extremo
  }
  console.log('⚠️ ANOMALÍA CRÍTICA: Consumo nulo por', consecutiveZeros, 'meses')
  break
}
```

---

## 📋 Tabla de Comparación: Antes vs Después

| Aspecto | Actual | Propuesto | Resultado |
|---------|--------|-----------|-----------|
| **Manejo de 0 kWh** | ❌ Se omite o falla | ✅ Se detecta explícitamente | Detecta nulos |
| **División por 0** | ❌ Error o NaN | ✅ Lógica especial | Sin errores |
| **Persistencia** | ⚠️ Solo 2-3 meses | ✅ Configurable 2+ | Más flexible |
| **Recuperación lenta** | ❌ No contempla | ✅ Detecta parcial | Detecta tendencia |
| **Confianza de 0s** | ❌ Baja | ✅ 95% alta | Más certero |

---

## 🎯 Implementación en Código

### Ubicación: `src/pages/ExportSaldoATR/ATRPreview.tsx`

**Líneas aproximadas:** 673-830

**Cambios necesarios:**

1. **Después de calcular baseline (línea ~600):**
   ```typescript
   // Agregar detección de consumos nulos
   const consecutiveZeroMonths = detectarConsumosNulos(withVar)
   ```

2. **En el loop de detección (línea ~660):**
   ```typescript
   // Agregar ANTES del loop existente:
   if (consecutiveZeroMonths.count >= 2) {
     // ... procesar anomalía nula
   }
   ```

3. **En validaciones cruzadas (línea ~680):**
   ```typescript
   // Modificar cálculo de variación:
   const variacion = calcularVariacionSegura(actual, anterior)
   ```

---

## ✅ Resumen de Problemas Identificados

| # | Problema | Impacto | Severidad |
|---|----------|--------|-----------|
| 1 | Consumo 0 no manejado | No detecta nulos | 🔴 CRÍTICA |
| 2 | División por 0 | Errores silenciosos | 🔴 CRÍTICA |
| 3 | Sin criterio nulo | Falsa negativa | 🟡 ALTA |
| 4 | Recuperación lenta | Pierde persistencia | 🟡 ALTA |
| 5 | Cambios de contador | Contexto perdido | 🟠 MEDIA |

---

## 📊 Caso Práctico: Cómo Debería Funcionar

```
ENTRADA: 50 meses de datos con anomalía 2022-02 a 2022-09

PASO 1: Detectar consumos nulos
├─ Mes 20 (2022-02): 0 kWh ← INICIO
├─ Mes 21 (2022-03): 0 kWh
├─ Mes 22 (2022-04): 0 kWh
├─ ...
├─ Mes 27 (2022-09): 0 kWh
└─ Mes 28 (2022-10): 7.592 kWh ← RECUPERACIÓN DÉBIL

RESULTADO: consecutiveZeros = 8

PASO 2: Evaluar persistencia
├─ ¿8 meses >= 2? → SÍ
├─ ¿Recuperación completa? → NO (solo 7.6 kWh)
└─ Persistencia score: MÁXIMA

PASO 3: Generar anomalía
CRITERIO: "Consumo nulo sostenido"
CONFIANZA: 95%
PERSISTENCIA: 8 meses
CAÍDA: 100%

SALIDA: ⚠️ ANOMALÍA DETECTADA
        Período: 2022-02
        Tipo: Consumo nulo prolongado (8 meses)
        Probabilidad de fraude/avería: MUY ALTA
```

---

**Documento actualizado:** 25 de octubre de 2025
**Análisis específico del cliente:** ES0031101927321001MV0F
